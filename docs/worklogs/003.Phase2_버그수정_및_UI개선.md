# Phase 2 버그 수정 및 UI 개선

**작업일**: 2026-02-07
**작업자**: Claude Code
**관련 계획서**: `docs/plans/001.프로젝트_구현_로드맵.md`

---

## 작업 개요

Phase 2 고객용 견적 신청 시스템 개발 중 발견된 버그 수정 및 UI 개선 작업

---

## 수정 내역

### 1. Turbopack 런타임 에러 해결

**문제**
- Windows 환경에서 `/estimate` 페이지 접속 시 Turbopack 패닉 발생
- 에러 코드: `0xc0000142` (Windows DLL 초기화 실패)
- CSS 처리 중 `globals.css` 파싱 실패

**원인**
- Next.js 16.1.6의 Turbopack이 Windows에서 PostCSS 처리 시 프로세스 충돌

**해결**
- `package.json`의 dev 스크립트를 `next dev --webpack`으로 변경
- Turbopack 대신 Webpack 사용

**수정 파일**
- `package.json`

**커밋**: `4768211`

---

### 2. FormSyncWrapper 런타임 TypeError 해결

**문제**
```
TypeError: Cannot read properties of undefined (reading 'needed')
at schemaToFormData (FormSyncWrapper.tsx:240:47)
```

**원인**
- `schema.services.airconInstall` 등 중첩 속성에 안전하지 않은 접근
- localStorage에 저장된 이전 버전 스키마에 해당 필드가 없을 수 있음

**해결**
- 모든 중첩 속성에 optional chaining (`?.`) 적용
- nullish coalescing (`??`) 연산자로 기본값 제공

**수정 파일**
- `src/components/form/FormSyncWrapper.tsx`

**수정 전**
```typescript
airconInstall: {
  needed: schema.services.airconInstall.needed,
  count: schema.services.airconInstall.qty,
},
```

**수정 후**
```typescript
airconInstall: {
  needed: schema.services?.airconInstall?.needed ?? false,
  count: schema.services?.airconInstall?.qty ?? 0,
},
```

**커밋**: `aca400b`

---

### 3. 채팅 스크롤 동작 개선

**문제**
- 가이드 입력 중 답변 선택 후 화면이 위로 스크롤됨
- 사용자 경험 저하

**원인**
- `useEffect`에서 `messages` 배열이 변경될 때마다 `scrollIntoView` 호출
- Step 입력 UI 렌더링 시에도 불필요하게 스크롤 발생

**해결**
- 메시지 수가 증가할 때만 스크롤 실행
- `scrollContainerRef`로 정확한 스크롤 컨테이너 지정
- `prevMessagesLengthRef`로 이전 메시지 수 추적

**수정 파일**
- `src/components/chat/ChatWindow.tsx`

**수정 전**
```typescript
useEffect(() => {
  messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
}, [messages]);
```

**수정 후**
```typescript
useEffect(() => {
  if (messages.length > prevMessagesLengthRef.current) {
    setTimeout(scrollToBottom, 100);
  }
  prevMessagesLengthRef.current = messages.length;
}, [messages.length, scrollToBottom]);
```

**커밋**: `aca400b`

---

### 4. 필수 항목 [object Object] 표시 오류 수정

**문제**
- 오른쪽 폼 패널에 "필수 항목: [object Object], [object Object]..." 표시
- 사용자가 어떤 필드가 누락되었는지 알 수 없음

**원인**
- `getMissingRequiredFields()`가 `MissingField[]` 객체 배열 반환
- `missingFields.slice(0, 3).join(', ')`로 객체를 직접 문자열 결합

**해결**
- 한국어 필드 라벨 매핑 객체 추가
- `MissingField.field`를 한국어 라벨로 변환

**수정 파일**
- `src/components/form/EstimateForm.tsx`

**추가된 코드**
```typescript
const FIELD_LABELS: Record<string, string> = {
  'move.category': '주거 형태',
  'move.type': '이사 형태',
  'move.schedule': '이사 예정일',
  'departure.address': '출발지 주소',
  'contact.name': '이름',
  'contact.phone': '연락처',
  // ... 기타 필드
};

const missingFieldLabels = missingFields
  .slice(0, 3)
  .map((f) => FIELD_LABELS[f.field] || f.field);
```

**표시 결과**
- 수정 전: `[object Object], [object Object], [object Object] 외 10개`
- 수정 후: `주거 형태, 이사 형태, 이사 예정일 외 10개`

**커밋**: `06f9f9b`

---

### 5. 진행률 표시 불일치 수정

**문제**
- 진행률이 `0%`로만 표시되거나 Progress 바가 거의 보이지 않음
- 하단 버튼에 `필수 정보를 입력해주세요 (0%)`만 표시

**원인**
- `engine.getCompletionRate()`가 0~1 범위 반환
- `Progress` 컴포넌트는 0~100 범위 기대
- 일부 컴포넌트는 `*100`, 일부는 그대로 사용하여 불일치

**해결**
- 모든 컴포넌트에서 `completionRate * 100`으로 통일

**수정 파일**
- `src/components/form/EstimateForm.tsx`
- `src/components/estimate/HybridLayout.tsx`

**커밋**: `06f9f9b`

---

## 커밋 이력

| 커밋 | 메시지 | 주요 변경 |
|------|--------|-----------|
| `4768211` | fix: use Webpack instead of Turbopack | package.json |
| `aca400b` | fix: resolve runtime errors in FormSyncWrapper and improve scroll | FormSyncWrapper.tsx, ChatWindow.tsx |
| `06f9f9b` | fix: correct progress display and missing fields labels | EstimateForm.tsx, HybridLayout.tsx |

---

## 테스트 결과

### 환경
- Windows 11
- Node.js
- Next.js 16.1.6 (Webpack)
- http://localhost:3002/estimate

### 확인 항목
- [x] `/estimate` 페이지 정상 로딩
- [x] 가이드 대화 진행 가능
- [x] 부가서비스 선택 후 다음 진행 정상
- [x] 필수 항목 한국어로 표시
- [x] 진행률 정상 표시 (0~100%)
- [x] 스크롤 동작 개선

---

## 남은 이슈

1. **TipCard 이미지 404**
   - `/tips/peak-season.svg`, `/tips/ladder-guide.svg` 등 파일 없음
   - 우선순위: 낮음 (기능에 영향 없음)

2. **SMS 인증 연동**
   - Solapi API 키 설정 필요
   - 현재 개발 모드에서는 콘솔에 인증번호 출력

---

## 참고

- Turbopack 버그는 Next.js 이슈로 추후 업데이트 시 해결될 수 있음
- localStorage 클리어 후 테스트 시 더 깨끗한 상태에서 확인 가능
