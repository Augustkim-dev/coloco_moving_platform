# 006. 가이드/자유입력 완료 후 필수항목 재확인 기능

## 작업 일시
2026-02-09

## 작업 개요
가이드 플로우 및 AI 자유입력 모드에서 플로우 완료 후 누락된 필수 입력항목을 재확인하는 "복구 모드" 기능 구현

## 수정 파일

### 1. src/lib/guided-flow/steps.ts
- `RecoveryStepConfig` 인터페이스 추가
- `FIELD_TO_RECOVERY_CONFIG` 매핑 추가 (13개 필수 필드)
  - 기존 GUIDED_STEPS의 options 재사용
  - 각 필드별 질문, inputType, options, description, placeholder, transform 설정
- `createRecoveryStep()` 함수 추가
  - 필드 경로를 받아 GuidedStep 형태의 복구 스텝 생성

### 2. src/stores/chatStore.ts
- **타입 확장:**
  - `ChatState` 인터페이스에 복구 모드 상태 추가
    - `isInRecoveryMode: boolean`
    - `currentRecoveryStep: GuidedStep | null`
    - `attemptedRecoveryFields: Set<string>` (무한 루프 방지)

- **showNextStep() 수정:**
  - 일반 플로우 완료 후 `getMissingRequiredFields()` 확인
  - 누락 필드가 있으면 `createRecoveryStep()`으로 복구 질문 생성
  - 첫 복구 모드 진입 시 안내 메시지 표시
  - `attemptedRecoveryFields`로 시도한 필드 추적 (무한 루프 방지)

- **handleGuidedAnswer() 수정:**
  - 복구 스텝 vs 일반 스텝 분기 처리
  - 복구 스텝: transform 함수 사용 또는 setFieldValue 직접 호출

- **clearChat() 수정:**
  - 복구 모드 상태 초기화 추가

- **revertToStep() 수정:**
  - 이전 스텝으로 되돌아갈 때 복구 모드 상태 초기화

- **셀렉터 추가:**
  - `selectIsInRecoveryMode`
  - `selectCurrentRecoveryStep`

## 동작 방식

### 가이드 모드
```
Step 16 완료 → showNextStep() → getMissingRequiredFields()
  ↓
누락 필드 있음 → createRecoveryStep() → 복구 질문 표시
  ↓
사용자 답변 → handleGuidedAnswer() → showNextStep() (반복)
  ↓
모든 필수항목 완료 → "견적 요청하기" 버튼 표시
```

### 자유입력 모드
```
자유 텍스트 입력 → AI 파싱 → showNextStep()
  ↓
(동일한 복구 로직 적용)
```

## 핵심 포인트
1. **단일 진입점:** 두 모드 모두 `showNextStep()`을 거치므로 한 곳에서 복구 로직 처리
2. **무한 루프 방지:** `attemptedRecoveryFields`로 이미 시도한 필드 추적
3. **UI 재사용:** 기존 GuidedStepRenderer 컴포넌트 그대로 사용
4. **transform 재사용:** 기존 Step의 transform 함수 재사용 (예: hasElevator → ladderTruck 연동)

## 테스트 체크리스트
- [ ] 가이드 모드: "모르겠어요" 선택 후 Step 16 완료 시 복구 질문 표시
- [ ] 자유입력 모드: 부분 정보 입력 후 복구 질문 표시
- [ ] 복구 질문 답변 후 스키마 정상 업데이트
- [ ] 모든 필수항목 완료 후 "견적 요청하기" 버튼 표시
- [ ] 무한 루프 방지 동작 확인

## 빌드 결과
```
✓ Compiled successfully in 5.3s
✓ Generating static pages (18/18)
```
