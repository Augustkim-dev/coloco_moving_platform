# 006. 가이드/자유입력 완료 후 필수항목 재확인 기능

## Context

**가이드 플로우**와 **AI 자유입력 모드** 모두에서, 플로우가 완료된 후 아직 필수 입력항목이 누락되어 있으면 추가 질문을 통해 재입력을 받아야 합니다.

**문제 상황:**
- 현재 `showNextStep()`은 16개 Step 완료 후 바로 "완료" 메시지 표시
- **가이드 모드:** 사용자가 일부 Step에서 "모르겠어요" 선택 시 필수값 누락
- **자유입력 모드:** AI 파싱에서 일부 필드만 추출되어 누락 발생 가능

**해결 목표:**
- 가이드/자유입력 모두 `showNextStep()` 호출 시 `getMissingRequiredFields()` 확인
- 누락 필드에 대해 동적으로 "복구 질문" 생성
- 모든 필수항목 채워질 때까지 추가 질문 진행

**적용 범위:**
| 모드 | 트리거 | 처리 위치 |
|------|--------|----------|
| 가이드 모드 | Step 16 완료 후 | `handleGuidedAnswer()` → `showNextStep()` |
| 자유입력 모드 | AI 파싱 완료 후 | `handleFreeTextInput()` → `showNextStep()` (라인 379) |

---

## 구현 계획

### 1. steps.ts - 필드-스텝 매핑 추가

**파일:** `src/lib/guided-flow/steps.ts`

기존 GUIDED_STEPS의 options를 재사용하여 필드별 복구 스텝 설정 추가:

```typescript
// 필드 경로 → 복구 스텝 설정 매핑
export const FIELD_TO_RECOVERY_CONFIG: Record<string, {
  inputType: StepInputType;
  question: string;
  options?: StepOption[];
  description?: string;
  placeholder?: string;
}> = {
  'move.category': {
    inputType: 'card',
    question: '어떤 공간에서 이사하시나요?',
    options: GUIDED_STEPS[1].options, // Step 2 재사용
  },
  'move.type': {
    inputType: 'card',
    question: '어떤 이사 서비스를 원하시나요?',
    options: GUIDED_STEPS[3].options, // Step 4 재사용
  },
  // ... 13개 필수 필드 모두 매핑
};

// 복구 스텝 생성 함수
export function createRecoveryStep(fieldPath: string): GuidedStep | null;
```

### 2. chatStore.ts - 복구 모드 상태 추가

**파일:** `src/stores/chatStore.ts`

```typescript
interface ChatState {
  // 기존 필드들...

  // 복구 모드 상태 추가
  isInRecoveryMode: boolean;
  currentRecoveryStep: GuidedStep | null;
  attemptedRecoveryFields: Set<string>; // 무한 루프 방지
}
```

### 3. showNextStep() 수정 - 핵심 로직

**파일:** `src/stores/chatStore.ts` (라인 224-258)

```typescript
showNextStep: () => {
  const { currentStepId, completedStepIds, attemptedRecoveryFields } = get();
  const nextStep = findNextActiveStep(currentStepId, completedStepIds);

  if (nextStep) {
    // 일반 플로우 진행 (기존 로직)
    // ...
    return;
  }

  // === 추가: 복구 모드 진입 ===
  const estimateStore = useEstimateStore.getState();
  const missingFields = estimateStore.engine.getMissingRequiredFields();

  // 시도하지 않은 누락 필드 필터링
  const unAttempted = missingFields.filter(
    f => !attemptedRecoveryFields.has(f.field)
  );

  if (unAttempted.length > 0) {
    const nextMissing = unAttempted[0]; // 우선순위순 정렬됨
    const recoveryStep = createRecoveryStep(nextMissing.field);

    if (recoveryStep) {
      // 첫 복구 모드 진입 시 안내 메시지
      if (!get().isInRecoveryMode) {
        get().addMessage({
          role: 'system',
          content: '입력이 누락된 항목이 있어요. 추가 확인이 필요합니다.',
        });
      }

      // 복구 질문 표시
      get().addMessage({
        role: 'system',
        content: recoveryStep.question,
        stepId: recoveryStep.id,
        inputComponent: recoveryStep.inputType,
        options: recoveryStep.options,
      });

      set({
        currentStepId: recoveryStep.id,
        isInRecoveryMode: true,
        currentRecoveryStep: recoveryStep,
        attemptedRecoveryFields: new Set([...attemptedRecoveryFields, nextMissing.field]),
      });
      return;
    }
  }

  // 모든 필수항목 완료 → 제출 가능
  set({ isInRecoveryMode: false, currentRecoveryStep: null });

  if (estimateStore.canSubmit()) {
    get().addMessage({
      role: 'system',
      content: '모든 정보 입력이 완료되었어요! 아래 버튼을 눌러 견적을 요청해주세요.',
    });
  }
};
```

### 4. handleGuidedAnswer() 수정 - 복구 답변 처리

**파일:** `src/stores/chatStore.ts` (라인 191-221)

복구 스텝 답변 시 `setFieldValue()` 직접 호출하여 스키마 업데이트:

```typescript
handleGuidedAnswer: (stepId, value, displayText) => {
  const { isInRecoveryMode, currentRecoveryStep } = get();

  // 사용자 답변 메시지 추가
  get().addMessage({ role: 'user', content: displayText, stepId, editable: true });

  if (isInRecoveryMode && currentRecoveryStep?.id === stepId) {
    // 복구 스텝: schemaPath로 직접 업데이트
    estimateStore.setFieldValue(currentRecoveryStep.schemaPath, value, 'guided');
    set({ currentRecoveryStep: null });
  } else {
    // 일반 스텝: engine.processAnswer 사용 (기존 로직)
    // ...
  }

  // 다음 스텝 표시
  setTimeout(() => get().showNextStep(), 300);
};
```

### 5. clearChat() 및 revertToStep() 수정

복구 모드 상태 초기화 추가:

```typescript
clearChat: () => {
  set({
    // 기존 필드들...
    isInRecoveryMode: false,
    currentRecoveryStep: null,
    attemptedRecoveryFields: new Set(),
  });
};

revertToStep: (stepId) => {
  // 기존 로직...
  // 일반 스텝으로 되돌아갈 때 복구 모드 해제
  set({
    // 기존 설정들...
    isInRecoveryMode: false,
    attemptedRecoveryFields: new Set(),
  });
};
```

---

## 수정 파일 목록

| 파일 | 변경 내용 |
|------|----------|
| `src/lib/guided-flow/steps.ts` | `FIELD_TO_RECOVERY_CONFIG` 매핑, `createRecoveryStep()` 함수 추가 |
| `src/stores/chatStore.ts` | 복구 모드 상태 추가, `showNextStep()` 수정, `handleGuidedAnswer()` 수정 |

---

## 흐름도

### 가이드 모드
```
Step 16 (contact_verification) 완료
         ↓
   handleGuidedAnswer()
         ↓
   showNextStep()
         ↓
   nextStep = null (일반 플로우 종료)
         ↓
   getMissingRequiredFields()
         ↓
    ┌────┴────┐
 [없음]     [있음]
    ↓          ↓
 완료 메시지   createRecoveryStep()
    ↓          ↓
 제출 버튼    복구 질문 표시
              ↓
           사용자 답변
              ↓
           showNextStep() ← 반복
```

### 자유입력 모드 (AI 파싱)
```
사용자 자유 텍스트 입력
         ↓
   handleFreeTextInput()
         ↓
   /api/chat (AI 파싱)
         ↓
   applyAIUpdate() - 파싱된 필드 적용
         ↓
   completedSteps 업데이트 (신뢰도 0.8 이상)
         ↓
   showNextStep() ← 동일한 복구 로직 진입
         ↓
   getMissingRequiredFields()
         ↓
    ┌────┴────┐
 [없음]     [있음]
    ↓          ↓
 완료 메시지   createRecoveryStep()
    ↓          ↓
 제출 버튼    복구 질문 표시 (가이드 UI로)
```

**핵심:** 두 모드 모두 `showNextStep()`을 거치므로, 이 함수에 복구 로직을 추가하면 양쪽 모두 자동 적용됨

---

## 검증 방법

1. **개발 서버 실행:** `npm run dev`

2. **가이드 모드 테스트:**
   - [ ] 가이드 플로우 진행 중 일부 필드에 "모르겠어요" 선택
   - [ ] Step 16(연락처 인증)까지 완료
   - [ ] "입력이 누락된 항목이 있어요" 메시지 표시 확인
   - [ ] 누락 필드에 대한 복구 질문 순차 표시 확인
   - [ ] 모든 필수항목 입력 후 "견적 요청하기" 버튼 표시 확인

3. **자유입력 모드 테스트:**
   - [ ] 자유입력 모드로 전환
   - [ ] "다음주 월요일 강남에서 마포로 원룸 이사해요" 같은 부분 정보 입력
   - [ ] AI 파싱 후 일부 Step만 완료 처리됨 확인
   - [ ] 가이드 질문으로 나머지 Step 진행
   - [ ] Step 16 완료 후 누락 필드 복구 질문 표시 확인
   - [ ] 모든 필수항목 완료 후 제출 버튼 표시 확인

4. **엣지 케이스:**
   - [ ] 복구 질문에서 다시 "모르겠어요" 선택 시 무한 루프 방지 확인
   - [ ] 이전 Step으로 되돌아가기 후 복구 모드 초기화 확인
