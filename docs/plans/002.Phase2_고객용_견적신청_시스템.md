# Phase 2: 고객용 견적 신청 시스템 (Week 3-4)

## Context
Phase 1 완료 상태에서 고객용 견적 신청 시스템을 구현한다. 3-Mode 입력 시스템(가이드 대화 + 자유 입력 + 폼 직접)을 통해 AI 비용을 최소화하면서 사용자 친화적인 견적 신청 경험을 제공한다.

**핵심 목표:**
- Input Schema v2.1 기반 데이터 구조
- 가이드 대화 기본 모드 (AI 호출 0회)
- 채팅 ↔ 폼 실시간 양방향 동기화
- 13개 필수 필드 완료 시 제출 가능

---

## Week 3: 핵심 인프라 구축 (Day 1-5)

### Day 1: Input Schema 타입 정의

**파일: `src/types/schema.ts`**
```typescript
// 9개 섹션 인터페이스
export interface MovingSchema {
  meta: MetaInfo;           // 요청 메타 (requestId, source, platform)
  move: MoveInfo;           // 이사 기본 (category, type, schedule, timeSlot)
  departure: LocationInfo;  // 출발지 (address, floor, elevator, squareFootage)
  arrival: LocationInfo;    // 도착지
  cargo: CargoInfo;         // 짐 정보 (appliances, furniture, special, boxes)
  services: Services;       // 부가 서비스 (ladderTruck, aircon, cleaning 등)
  conditions: Conditions;   // 기타 조건 (extraRequests, vehiclePreference)
  contact: ContactInfo;     // 연락처 (name, phone, carrier)
  status: StatusInfo;       // 상태 (completionRate, missingRequired, readyForSubmit)
}

export function createDefaultSchema(): MovingSchema;
```

**참조:** `docs/structure/이삿짐_플랫폼_Input_Schema_v2.1.md`

---

### Day 1-2: 가이드 대화 시스템

**파일: `src/lib/guided-flow/steps.ts`**
- 15개 Step 정의 (question, inputType, schemaPath, skipCondition)
- TipCard 정의 (truck_count, worker_participation, ladder_truck, peak_season)

**파일: `src/lib/guided-flow/engine.ts`**
```typescript
export class GuidedFlowEngine {
  getNextStep(): GuidedStep | null;      // skipCondition 평가
  processAnswer(stepId: string, value: any): MovingSchema;
  getCompletionRate(): number;           // 13개 필수 필드 기준
  canSubmit(): boolean;
}
```

**15개 Step 흐름:**
| # | 질문 | UI 타입 | Schema 경로 |
|---|------|---------|-------------|
| 1 | 이사 예정일 | calendar | move.schedule |
| 2 | 현재 평수 | select | departure.squareFootage |
| 3 | 이사 형태 | card | move.type |
| 4 | 시작 시간 | button_list | move.timeSlot |
| 5 | 출발지 주소 | address | departure.address |
| 6 | 출발지 운반 방식 | button_list | departure.hasElevator |
| 7 | 출발지 층수 | number | departure.floor |
| 8 | 도착지 주소 | address | arrival.address |
| 9 | 도착지 운반 방식 | button_list | arrival.hasElevator |
| 10 | 도착지 층수 | number | arrival.floor |
| 11 | 트럭 대수 | button_list | conditions.vehiclePreference |
| 12 | 작업인원 | button_list | conditions.customerParticipation |
| 13 | 짐 상세 & 요청 | textarea | conditions.extraRequests |
| 14 | 부가 서비스 | toggle_list | services.* |
| 15 | 본인 인증 | phone_verify | contact.* |

**조건부 스킵:**
- Step 11,12: 포장/반포장이사 시 스킵
- Step 14: 용달이사 시 스킵

---

### Day 2-3: Zustand 스토어

**파일: `src/stores/estimateStore.ts`**
```typescript
interface EstimateState {
  schema: MovingSchema;
  updateField: (section, data) => void;
  mergeSchema: (partial) => void;      // AI 파싱 결과 적용
  setFieldValue: (path, value) => void; // dot notation
  recalculateStatus: () => void;
  syncToDatabase: () => Promise<void>;
}
```

**파일: `src/stores/chatStore.ts`**
```typescript
interface ChatState {
  messages: ChatMessage[];
  inputMode: 'guided' | 'free_text';
  flowEngine: GuidedFlowEngine;
  handleGuidedAnswer: (stepId, value) => void;
  handleFreeTextInput: (text) => Promise<void>;
}
```

---

### Day 3-5: 채팅 UI 컴포넌트

**디렉토리: `src/components/chat/`**

| 파일 | 목적 | 우선순위 |
|------|------|----------|
| `ChatWindow.tsx` | 채팅 컨테이너 + ProgressBar | 높음 |
| `ChatBubble.tsx` | 메시지 버블 (user/system/ai) | 높음 |
| `GuidedStepRenderer.tsx` | Step별 UI 분기 렌더링 | 높음 |
| `TipCard.tsx` | 팁 카드 (일러스트 + 가이드) | 높음 |
| `InlineDatePicker.tsx` | 캘린더 (Step 1) | 높음 |
| `CardSelector.tsx` | 카드형 선택 (Step 3) | 높음 |
| `ButtonList.tsx` | 버튼 리스트 (Step 4,6,9,11,12) | 높음 |
| `FloorInput.tsx` | 층수 입력 (지상/지하 토글) | 높음 |
| `ChatInputBar.tsx` | 하단 입력창 | 높음 |
| `RangeSelector.tsx` | 범위 선택 (Step 2) | 중간 |
| `TextAreaInput.tsx` | 텍스트 입력 (Step 13) | 중간 |
| `ServiceToggleList.tsx` | 토글 리스트 (Step 14) | 중간 |

**shadcn/ui 추가 필요:**
```bash
npx shadcn@latest add calendar dialog select textarea toggle progress badge tabs
```

---

## Week 4: 폼/AI/페이지 구현 (Day 6-10)

### Day 6: 폼 컴포넌트 & 하이브리드 레이아웃

**디렉토리: `src/components/form/`**

| 파일 | 목적 |
|------|------|
| `FormSyncWrapper.tsx` | RHF + Zustand 양방향 동기화 |
| `EstimateForm.tsx` | 전체 폼 컨테이너 |
| `MoveSection.tsx` | 이사 기본 정보 |
| `LocationSection.tsx` | 출발지/도착지 |
| `CargoSection.tsx` | 짐 정보 |
| `ServicesSection.tsx` | 부가 서비스 |
| `ContactSection.tsx` | 연락처 |

**파일: `src/components/estimate/HybridLayout.tsx`**
```typescript
// 모바일: 하단 탭 전환 (채팅/폼)
// 데스크톱: 좌우 50:50 분할
export function HybridLayout() {
  const isMobile = useMediaQuery('(max-width: 768px)');
  // ...
}
```

---

### Day 7: AI 파싱 모듈

**파일: `src/lib/gemini/client.ts`**
- Gemini 2.5 Flash API 클라이언트
- JSON 모드 응답 설정

**파일: `src/lib/gemini/prompts.ts`**
- 이사 정보 파싱 프롬프트
- confidence 점수 포함 응답 형식

**파일: `src/lib/utils/inputDetector.ts`**
```typescript
export function shouldCallAI(userInput: string, currentStep: GuidedStep): boolean {
  // 1. 옵션 정확 매칭 → false
  // 2. 단순 숫자 → false
  // 3. 키워드 2개 이상 or 20자 이상 → true
}
```

**설치 필요:**
```bash
npm install @google/generative-ai
```

---

### Day 8: API 라우트 & 주소 검색

**파일: `src/app/api/chat/route.ts`**
- AI 파싱 프록시 (API 키 서버 보호)

**파일: `src/components/chat/AddressSearch.tsx`**
- 카카오 주소 검색 API 연동
- 검색 결과 리스트 + 선택

---

### Day 9: 견적 신청 페이지

**파일: `src/app/(customer)/estimate/page.tsx`**
```typescript
export default function EstimatePage() {
  return (
    <FormSyncWrapper>
      <HybridLayout />
    </FormSyncWrapper>
  );
}
```

**파일: `src/app/(customer)/estimate/confirm/page.tsx`**
- 입력 정보 요약 카드
- 약관 동의 체크박스
- 견적 요청 제출 버튼

---

### Day 10: SMS 인증 & 마무리

**파일: `src/components/chat/PhoneVerification.tsx`**
- 이름, 휴대폰, 통신사 입력
- 인증번호 발송/확인

**파일: `src/app/api/auth/send-code/route.ts`**
- Solapi SMS 발송

**파일: `src/app/api/auth/verify-code/route.ts`**
- 인증번호 확인

---

## 생성할 파일 목록 (우선순위 순)

### Week 3 (핵심)
| # | 파일 | 의존성 |
|---|------|--------|
| 1 | `src/types/schema.ts` | - |
| 2 | `src/lib/guided-flow/steps.ts` | schema.ts |
| 3 | `src/lib/guided-flow/engine.ts` | steps.ts |
| 4 | `src/stores/estimateStore.ts` | schema.ts |
| 5 | `src/stores/chatStore.ts` | engine.ts |
| 6 | `src/components/chat/ChatWindow.tsx` | chatStore |
| 7 | `src/components/chat/ChatBubble.tsx` | - |
| 8 | `src/components/chat/GuidedStepRenderer.tsx` | steps.ts |
| 9 | `src/components/chat/TipCard.tsx` | - |
| 10 | `src/components/chat/InlineDatePicker.tsx` | shadcn/calendar |
| 11 | `src/components/chat/CardSelector.tsx` | - |
| 12 | `src/components/chat/ButtonList.tsx` | - |
| 13 | `src/components/chat/FloorInput.tsx` | - |
| 14 | `src/components/chat/ChatInputBar.tsx` | chatStore |

### Week 4
| # | 파일 | 의존성 |
|---|------|--------|
| 15 | `src/components/form/FormSyncWrapper.tsx` | estimateStore |
| 16 | `src/components/form/EstimateForm.tsx` | FormSyncWrapper |
| 17 | `src/components/form/*Section.tsx` (5개) | schema.ts |
| 18 | `src/components/estimate/HybridLayout.tsx` | ChatWindow, EstimateForm |
| 19 | `src/lib/gemini/client.ts` | - |
| 20 | `src/lib/gemini/prompts.ts` | schema.ts |
| 21 | `src/lib/utils/inputDetector.ts` | steps.ts |
| 22 | `src/app/api/chat/route.ts` | gemini/client |
| 23 | `src/components/chat/AddressSearch.tsx` | Kakao API |
| 24 | `src/app/(customer)/estimate/page.tsx` | HybridLayout |
| 25 | `src/app/(customer)/estimate/confirm/page.tsx` | estimateStore |
| 26 | `src/components/chat/PhoneVerification.tsx` | - |
| 27 | `src/app/api/auth/send-code/route.ts` | Solapi |
| 28 | `src/app/api/auth/verify-code/route.ts` | - |

---

## 환경 변수 추가 필요

```env
# Gemini AI
GEMINI_API_KEY=your_gemini_api_key

# Kakao 주소 검색
NEXT_PUBLIC_KAKAO_JS_KEY=your_kakao_js_key
KAKAO_REST_API_KEY=your_kakao_rest_key

# Solapi SMS
SOLAPI_API_KEY=your_solapi_key
SOLAPI_API_SECRET=your_solapi_secret
SOLAPI_SENDER=01012345678
```

---

## 검증 방법

### Week 3 완료 기준
- [ ] Input Schema 타입 정의 완료
- [ ] 15개 가이드 Step 정의 + skipCondition 작동
- [ ] GuidedFlowEngine Step 진행/수정 처리
- [ ] estimateStore 스키마 업데이트 + persist
- [ ] 채팅 UI 모바일 터치 친화적 렌더링

### Week 4 완료 기준
- [ ] 폼 ↔ estimateStore 양방향 동기화
- [ ] HybridLayout 모바일/데스크톱 반응형
- [ ] shouldCallAI() AI 호출 판단 정확
- [ ] 카카오 주소 검색 정상 작동
- [ ] SMS 인증 플로우 완료
- [ ] 13개 필수 필드 완료 시 제출 버튼 활성화
- [ ] Supabase estimates 테이블 저장 확인

```bash
npm run dev
# http://localhost:3000/estimate 접속
# 가이드 대화 → 폼 동기화 확인
# 제출 → Supabase 대시보드 확인
```

---

## 참고 문서
- `docs/structure/이삿짐_플랫폼_Input_Schema_v2.1.md`
- `docs/structure/이삿짐_입력전략_설계서_v1.1.md`
- `docs/plans/001.프로젝트_구현_로드맵.md`
