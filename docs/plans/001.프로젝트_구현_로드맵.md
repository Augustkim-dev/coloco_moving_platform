# 이사매칭 플랫폼 구현 로드맵

## 프로젝트 개요

**프로젝트명:** 이사매칭 (Moving Match)
**작성일:** 2026-02-06
**기준 문서:** PRD v1.2, 기술 스택 v1.0, Input Schema v2.1, 입력 전략 v1.1
**총 개발 기간:** 8주 (MVP)

---

## 핵심 기술 스택

| 영역 | 기술 | 버전 | 비고 |
|------|------|------|------|
| **프론트엔드** | Next.js (App Router) | 15.x | SSR/SSG, 모바일 퍼스트 |
| **언어** | TypeScript | 5.x | 타입 안정성 |
| **스타일링** | Tailwind CSS + shadcn/ui | 4.x | 반응형 UI |
| **상태관리** | Zustand | 5.x | 채팅+폼 동기화 |
| **폼 관리** | React Hook Form + Zod | latest | Schema 기반 검증 |
| **백엔드** | Supabase | latest | Auth/DB/Storage/Realtime/Edge Functions |
| **DB** | PostgreSQL (Supabase) | 15 | RLS, JSONB 지원 |
| **AI** | Gemini 2.5 Flash | latest | 무료 티어, JSON 모드 파싱 |
| **주소 API** | 카카오 주소 API | v3 | 한국 주소 검색 |
| **SMS** | Solapi | - | 본인 인증 (~15원/건) |
| **배포** | Vercel | - | Next.js 최적화 |

---

## 핵심 기능 요약

### 1. 3모드 입력 시스템
| 모드 | 설명 | AI 호출 | 비용 |
|------|------|---------|------|
| **가이드 대화 (기본)** | 챗봇이 질문 → 버튼/카드로 답변 | 없음 | $0 |
| **자유 입력** | 자연어 입력 → AI 파싱 | Gemini | ~0.001원/건 |
| **폼 직접** | 전통적인 폼 필드 | 없음 | $0 |

### 2. AI 매칭 알고리즘 (가중치)
- 지역: 30% (출발/도착지 커버 여부)
- 이사 형태: 25% (업체 전문 분야 일치)
- 일정: 20% (희망일 가용 여부)
- 차량: 15% (필요 톤수 보유)
- 평점: 10% (고객 리뷰 기반)

### 3. 3역할 시스템
- **고객**: 견적 신청, 매칭 결과 확인, 리뷰 작성
- **업체**: 매칭 수신, 수락/거절, 고객 연락
- **관리자**: 매칭 모니터링, 업체/고객 관리, 정산

---

## Phase 1: 프로젝트 기반 구축 (Week 1-2)

### 1-1. 프로젝트 초기 세팅
- [ ] Next.js 15 프로젝트 생성 (App Router, TypeScript)
- [ ] Tailwind CSS 4.x + shadcn/ui 설정
- [ ] Zustand, React Hook Form, Zod 설치
- [ ] ESLint, Prettier 설정
- [ ] 디렉토리 구조 생성

```
src/
├── app/                    # Next.js App Router
│   ├── (customer)/         # 고객용 라우트
│   ├── (company)/          # 업체용 라우트
│   ├── (admin)/            # 관리자 라우트
│   └── api/                # API Routes
├── components/
│   ├── ui/                 # shadcn/ui 컴포넌트
│   ├── chat/               # 채팅 컴포넌트
│   ├── form/               # 폼 컴포넌트
│   └── estimate/           # 견적 페이지 전용
├── lib/
│   ├── supabase/           # Supabase 클라이언트
│   ├── gemini/             # Gemini API
│   ├── guided-flow/        # 가이드 대화 엔진
│   └── utils/              # 유틸리티
├── stores/                 # Zustand 스토어
└── types/                  # TypeScript 타입
```

### 1-2. Supabase 설정
- [ ] Supabase 프로젝트 생성
- [ ] 환경 변수 설정 (.env.local)
```env
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=
```
- [ ] Supabase 클라이언트 설정 (client.ts, server.ts, middleware.ts)

### 1-3. DB 스키마 마이그레이션

| 테이블 | 설명 | 핵심 컬럼 |
|--------|------|-----------|
| **profiles** | 사용자 | id, role, name, phone |
| **companies** | 업체 | user_id, business_name, service_regions[], move_types[], avg_rating |
| **estimates** | 견적 요청 | user_id, schema_data (JSONB), status, completion_rate |
| **matchings** | 매칭 이력 | estimate_id, company_id, status, match_score, expires_at |
| **reviews** | 리뷰 | matching_id, rating, comment |
| **chat_messages** | 채팅 이력 | estimate_id, role, content |

- [ ] profiles 테이블 생성
- [ ] companies 테이블 생성
- [ ] estimates 테이블 생성 (schema_data JSONB)
- [ ] matchings 테이블 생성
- [ ] reviews 테이블 생성
- [ ] chat_messages 테이블 생성
- [ ] RLS 정책 설정 (역할별 접근 제어)
- [ ] JSONB 인덱스 생성 (매칭 필터링용)

### 1-4. 인증 시스템
- [ ] Supabase Auth 설정
- [ ] 카카오 OAuth 연동
- [ ] 비회원 SMS 인증 플로우 (Solapi)
- [ ] 역할 분리 (customer/company/admin)
- [ ] 미들웨어 인증 체크

### 1-5. 외부 API 연동
- [ ] 카카오 주소 API 연동
```env
NEXT_PUBLIC_KAKAO_JS_KEY=
KAKAO_REST_API_KEY=
```
- [ ] Solapi SMS API 연동
```env
SOLAPI_API_KEY=
SOLAPI_API_SECRET=
SOLAPI_SENDER=
```

### Phase 1 검증
- [ ] `npm run dev` 실행 → Supabase 연결 확인
- [ ] 카카오 주소 검색 동작 테스트
- [ ] SMS 인증 발송/검증 테스트

---

## Phase 2: 고객용 견적 신청 (Week 3-4)

### 2-1. Input Schema 타입 정의
- [ ] `types/schema.ts` - MovingSchema 전체 인터페이스

```typescript
interface MovingSchema {
  meta: { requestId, source, platform, version };
  move: { category, type, schedule, timeSlot };
  departure: { address, floor, hasElevator, parking, squareFootage };
  arrival: { address, floor, hasElevator, parking, squareFootage };
  cargo: { appliances, furniture, special, boxes };
  services: { ladderTruck, airconInstall, cleaning, storage, disposal };
  conditions: { extraRequests, vehiclePreference, customerParticipation };
  contact: { name, phone, carrier, preferredTime };
  status: { completionRate, missingRequired, fieldConfidence, readyForSubmit };
}
```

- [ ] `lib/utils/schema.ts` - Schema 유틸리티 (createEmptySchema, mergeSchema 등)
- [ ] `lib/utils/validation.ts` - Zod 검증 스키마

### 2-2. 가이드 대화 시스템 (Rule-based, AI 불필요)

**15개 Step Flow:**
1. 이사 예정일 (캘린더)
2. 현재 거주지 평수 (선택)
3. 이사 형태 (카드 선택)
4. 이사 시작 시간 (버튼)
5. 출발지 주소 (카카오 검색)
6. 출발지 운반 방식 (엘리베이터/계단/사다리차)
7. 출발지 층수 (숫자 입력)
8. 도착지 주소 (카카오 검색)
9. 도착지 운반 방식
10. 도착지 층수
11. 트럭 대수 (용달/일반 시) + 팁 카드
12. 작업인원 (용달/일반 시) + 팁 카드
13. 자세한 짐 양/요청사항 (텍스트)
14. 부가 서비스 (토글)
15. 본인 인증 (SMS)

- [ ] `lib/guided-flow/steps.ts` - Step 정의
- [ ] `lib/guided-flow/engine.ts` - Step 진행 엔진
- [ ] `lib/guided-flow/conditions.ts` - 조건부 스킵 로직
- [ ] `lib/guided-flow/transforms.ts` - 답변→Schema 매핑

### 2-3. 채팅 UI 컴포넌트
- [ ] `components/chat/ChatWindow.tsx` - 채팅 컨테이너
- [ ] `components/chat/ChatMessage.tsx` - 메시지 버블
- [ ] `components/chat/ChatInput.tsx` - 입력창 (가이드/자유 전환)
- [ ] `components/chat/GuidedStep.tsx` - 가이드 Step 렌더러
- [ ] `components/chat/TipCard.tsx` - 팁 카드 (일러스트+가이드)

**입력 위젯:**
- [ ] InlineDatePicker - 캘린더
- [ ] CardSelector - 카드형 선택
- [ ] ButtonList - 버튼 리스트
- [ ] FloorInput - 층수 입력 (지상/지하)
- [ ] KakaoAddressSearch - 주소 검색
- [ ] ServiceToggleList - 토글 리스트
- [ ] PhoneVerification - SMS 인증

### 2-4. 폼 UI 컴포넌트
- [ ] `components/form/EstimateForm.tsx` - 전체 폼 컨테이너
- [ ] `components/form/MoveInfoSection.tsx` - 이사 기본 정보
- [ ] `components/form/LocationSection.tsx` - 출발지/도착지
- [ ] `components/form/CargoSection.tsx` - 짐 정보
- [ ] `components/form/ServiceSection.tsx` - 부가 서비스
- [ ] `components/form/ContactSection.tsx` - 연락처

### 2-5. 하이브리드 레이아웃
- [ ] `components/estimate/HybridLayout.tsx` - 채팅+폼 동시 표시

```
[모바일]                    [데스크톱]
┌──────────────┐           ┌────────┬────────┐
│ 진행률 바     │           │ 채팅    │ 폼     │
├──────────────┤           │ (45%)  │ (55%)  │
│ 채팅 또는 폼  │           ├────────┴────────┤
├──────────────┤           │ [견적 신청하기]   │
│ [채팅] [폼]  │ ← 탭      └─────────────────┘
├──────────────┤
│ [견적신청]   │ ← CTA
└──────────────┘
```

- [ ] `components/estimate/ProgressBar.tsx` - 완성도 진행률
- [ ] `components/estimate/MobileTabSwitch.tsx` - 모바일 탭 전환

### 2-6. Zustand 상태 관리
- [ ] `stores/estimateStore.ts` - 견적 상태 (Single Source of Truth)
- [ ] `stores/chatStore.ts` - 채팅 상태
- [ ] 폼 ↔ 채팅 양방향 동기화 구현

```typescript
interface EstimateState {
  schema: MovingSchema;
  activeTab: 'chat' | 'form';
  applyAIUpdate: (updates, confidence) => void;
  updateField: (path, value) => void;
}
```

### 2-7. AI 파싱 연동 (자유 입력 모드)
- [ ] `lib/gemini/client.ts` - Gemini API 클라이언트
- [ ] `lib/gemini/prompts.ts` - 시스템 프롬프트
- [ ] `lib/gemini/parser.ts` - 응답 파싱 유틸
- [ ] `lib/utils/inputDetector.ts` - AI 호출 필요 여부 판단

```typescript
// 2개 이상 키워드 매칭 or 20자 이상 → AI 호출
function shouldCallAI(input: string): boolean
```

- [ ] `supabase/functions/parse-moving-input/index.ts` - Edge Function
```env
GEMINI_API_KEY=
```

### 2-8. 견적 신청 페이지
- [ ] `app/(customer)/page.tsx` - 랜딩 페이지
- [ ] `app/(customer)/estimate/page.tsx` - 견적 신청 (3모드 UI)
- [ ] `app/(customer)/estimate/confirm/page.tsx` - 정보 확인 & 동의
- [ ] `app/api/chat/route.ts` - AI 채팅 API 프록시

### Phase 2 검증
- [ ] 가이드 대화만으로 견적 신청 완료 (AI 호출 0회)
- [ ] 자유 입력 시 AI 파싱 → 여러 필드 자동 채움
- [ ] 폼 수정 ↔ 채팅 답변 동기화 확인
- [ ] 진행률 바 정확히 계산

---

## Phase 3: 업체용 시스템 + AI 매칭 (Week 5-6)

### 3-1. 업체 회원가입 & 프로필
- [ ] `app/(company)/register/page.tsx` - 업체 가입
  - 사업자 등록증, 허가증 제출
  - 서비스 지역 선택 (다중)
  - 전문 분야 (용달/일반/반포장/포장/보관)
  - 보유 차량 (톤수별)
- [ ] `app/(company)/profile/page.tsx` - 프로필 관리
- [ ] 일정 관리 (가용 날짜)

### 3-2. 업체 대시보드
- [ ] `app/(company)/dashboard/page.tsx`
  - 오늘의 매칭 건
  - 진행 중 건
  - 완료 건
- [ ] `app/(company)/matches/page.tsx` - 매칭 목록 & 상세
  - 고객 입력 정보 열람 (schema_data)
  - 수락/거절 버튼
  - 타임아웃 카운트다운

### 3-3. 매칭 알고리즘 (Rule-based v1)
- [ ] `supabase/functions/match-company/index.ts`

```
[견적 제출]
    ↓
[필터링] 지역 + 이사형태 + 일정
    ↓
[스코어링] 가중치 합산
    ↓
[최고 점수 업체 1곳 배정]
    ↓
[알림 발송]
```

- [ ] 필터링: 지역(departure, arrival) + 이사형태 + 일정
- [ ] 스코어링: 지역(30%) + 형태(25%) + 일정(20%) + 차량(15%) + 평점(10%)
- [ ] 최적 업체 1곳 자동 배정

### 3-4. 매칭 프로세스
- [ ] DB Trigger: 견적 status='submitted' → match-company 호출
- [ ] matchings 테이블 생성: status='pending', expires_at=now+30분
- [ ] 30분 타임아웃 처리: 미응답 시 차순위 업체 재배정
- [ ] 최대 3회 실패 → 관리자 수동 개입 알림
- [ ] `supabase/functions/handle-timeout/index.ts` - 스케줄러

### 3-5. 알림 시스템
- [ ] `supabase/functions/send-notification/index.ts`
- [ ] SMS 알림 (Solapi)
  - 업체: "새 매칭 건이 도착했습니다"
  - 고객: "매칭이 진행 중입니다"
- [ ] Supabase Realtime 채널 설정
  - `estimate:{id}` - 고객에게 상태 변경
  - `company:{id}` - 업체에게 새 매칭

### 3-6. 고객 결과 페이지
- [ ] `app/(customer)/estimate/result/page.tsx` - 매칭 결과 안내
  - 배정 업체 정보
  - 예상 비용 범위
  - 연락 안내
- [ ] `app/(customer)/mypage/page.tsx` - 신청 이력, 진행 현황

### Phase 3 검증
- [ ] 업체 가입 → 프로필 완성 → 대시보드 접근
- [ ] 고객 견적 제출 → 업체에 SMS 알림 수신
- [ ] 업체 수락 → 고객에게 결과 안내
- [ ] 업체 거절/타임아웃 → 차순위 재배정 동작

---

## Phase 4: 관리자 + 마무리 (Week 7-8)

### 4-1. 관리자 대시보드
- [ ] `app/(admin)/dashboard/page.tsx` - 메인 대시보드
  - KPI: 일별 신청, 매칭률, 완료율
  - 실시간 현황
- [ ] `app/(admin)/matches/page.tsx` - 매칭 관리
  - 전체 매칭 건 조회
  - 수동 재배정
  - 매칭 실패 건 처리
- [ ] `app/(admin)/companies/page.tsx` - 업체 관리
  - 업체 목록
  - 가입 심사 (승인/반려)
  - 평점 관리
  - 정지/해제
- [ ] `app/(admin)/customers/page.tsx` - 고객 관리
  - 고객 목록
  - 신청 이력
  - 클레임 처리

### 4-2. 정산 기본 구조
- [ ] `app/(company)/settlement/page.tsx` - 정산 내역
  - 월별 매칭 수수료 (MVP는 무료)
  - 이사 완료 건 목록
- [ ] 정산 테이블/로직 기초 구현 (Phase 2에서 활성화)

### 4-3. 리뷰 시스템
- [ ] 이사 완료 후 리뷰 작성 UI
- [ ] 별점 (1~5) + 한줄평
- [ ] 업체 avg_rating 자동 집계

### 4-4. PWA 설정
- [ ] `public/manifest.json`
```json
{
  "name": "이사매칭 - AI 이사 견적",
  "short_name": "이사매칭",
  "start_url": "/",
  "display": "standalone",
  "theme_color": "#2563EB"
}
```
- [ ] 아이콘 생성 (192x192, 512x512)
- [ ] 서비스 워커 (선택, next-pwa)

### 4-5. QA & 배포
- [ ] 기능 테스트 (전체 플로우)
  - 고객: 견적 신청 → 매칭 결과 → 리뷰
  - 업체: 가입 → 매칭 수신 → 수락
  - 관리자: 대시보드 확인
- [ ] 모바일 UX 점검
  - 터치 영역 (최소 48px)
  - 하단 CTA 고정
  - 탭 전환 자연스러움
- [ ] 성능 최적화
  - 이미지 최적화 (next/image)
  - 폰트 최적화
  - 번들 사이즈 확인
- [ ] Vercel 배포
- [ ] 도메인 연결
- [ ] 환경 변수 프로덕션 설정

### Phase 4 검증
- [ ] 관리자 대시보드 데이터 정상 표시
- [ ] 전체 E2E 시나리오 (고객→업체→완료→리뷰) 통과
- [ ] PWA 설치 가능 확인
- [ ] Vercel 배포 → 실제 URL 접속

---

## 주차별 일정 요약

| 주차 | 프론트엔드 | 백엔드 (Supabase) | AI |
|------|-----------|-------------------|-----|
| **W1** | Next.js 세팅, Tailwind/shadcn | DB 마이그레이션, Auth | — |
| **W2** | 견적 폼 UI (모바일 퍼스트) | estimates RLS, 주소 API | — |
| **W3** | 채팅 UI + 폼 동기화 | Edge Function 배포 | Gemini 연동, 프롬프트 |
| **W4** | 진행률 바, 확인/제출 페이지 | chat_messages, 자동 저장 | 파싱 정확도 튜닝 |
| **W5** | 업체 가입, 프로필, 대시보드 | companies, matchings | 매칭 알고리즘 v1 |
| **W6** | 매칭 알림 UI, 수락/거절 | SMS, Realtime, 타임아웃 | — |
| **W7** | 관리자 대시보드 | 정산 기본, 통계 쿼리 | — |
| **W8** | QA, PWA, 버그 수정 | 보안 점검, 성능 최적화 | 프롬프트 최종 튜닝 |

---

## 예상 비용 (MVP 초기)

| 항목 | 서비스 | 월 비용 |
|------|--------|---------|
| 호스팅 | Vercel Hobby | **$0** |
| BaaS | Supabase Free | **$0** |
| AI | Gemini 2.5 Flash 무료 | **$0** |
| SMS | Solapi (50건/일) | **~22,500** |
| 주소 API | 카카오 무료 | **$0** |
| 도메인 | .kr | ~20,000/년 |
| **합계** | | **~25,000/월** |

---

## 성공 지표

### MVP 단계 (런칭 전)
| 지표 | 목표 |
|------|------|
| 견적 요청 완료율 | 40% 이상 |
| 입력 완료 소요 시간 | 3분 이내 |
| 가이드 대화 완료율 | 70% 이상 |
| AI 파싱 활용 비율 | 30% 이하 |
| AI 파싱 정확도 | 80% 이상 |

### 서비스 단계 (런칭 후 3개월)
| 지표 | 목표 |
|------|------|
| 일 견적 신청 수 | 50건/일 |
| 매칭 성공률 | 90% 이상 |
| 이사 완료율 | 60% 이상 |
| 고객 만족도 | 4.0/5.0 이상 |

---

## 다음 단계

Phase 1부터 순차적으로 구현을 시작합니다.

**첫 번째 작업:** Next.js 15 프로젝트 생성 및 기본 설정
