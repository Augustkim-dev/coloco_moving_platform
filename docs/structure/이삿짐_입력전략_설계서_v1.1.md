# 이삿짐 AI 매칭 플랫폼 — 입력 전략 설계서

## Input Strategy Document v1.1

**기준 문서:** PRD v1.1, Input Schema v2.0, 기술 스택 v1.0
**작성일:** 2026-02-06
**업데이트:** 짐싸만 앱 UX 분석 반영 — 트럭 대수, 작업인원, 짐 상세, 본인인증, 팁 카드 추가
**핵심 변경:** 3가지 입력 모드 정의 (가이드 대화 / 자유 입력 / 폼 직접)

---

## 1. 입력 모드 개요

### 1.1 기존 설계의 문제

```
기존: 채팅(AI) + 폼 2가지 모드
→ 채팅 = 항상 AI API 호출
→ 간단한 선택형 질문도 AI 토큰 소비
→ 비용 낭비 + 불필요한 지연
```

### 1.2 개선된 3모드 전략

```
┌─────────────────────────────────────────────────────────┐
│                    견적 신청 페이지                        │
│                                                         │
│  ┌──────────────────────────────────────────────────┐   │
│  │              채팅 영역 (대화형 UI)                  │   │
│  │                                                    │   │
│  │  모드 A: 가이드 대화 (기본) ← AI 불필요             │   │
│  │  ┌────────────────────────────────────────┐       │   │
│  │  │ 🤖 이사 예정일은 언제인가요?              │       │   │
│  │  │    [📅 캘린더 열기]                      │       │   │
│  │  │                                        │       │   │
│  │  │ 🤖 이사 종류를 선택해주세요               │       │   │
│  │  │    [포장이사] [반포장이사] [일반이사]      │       │   │
│  │  │                                        │       │   │
│  │  │ 🤖 출발지 주소를 알려주세요               │       │   │
│  │  │    [🔍 주소 검색]                        │       │   │
│  │  └────────────────────────────────────────┘       │   │
│  │                                                    │   │
│  │  모드 B: 자유 입력 (선택) ← AI 호출               │   │
│  │  ┌────────────────────────────────────────┐       │   │
│  │  │ 💬 "원룸이고 3월 말에 강남에서 마포로       │       │   │
│  │  │     포장이사 해요. 냉장고랑 세탁기 있어요"   │       │   │
│  │  │                                        │       │   │
│  │  │ → Gemini API 호출 → 여러 필드 한번에 파싱  │       │   │
│  │  └────────────────────────────────────────┘       │   │
│  └──────────────────────────────────────────────────┘   │
│                                                         │
│  ┌──────────────────────────────────────────────────┐   │
│  │  모드 C: 폼 직접 입력 (선택)  ← AI 불필요         │   │
│  │  ┌────────────────────────────────────────┐       │   │
│  │  │ 이사 종류:  [원룸 ▾]                     │       │   │
│  │  │ 이사 형태:  [포장이사 ▾]                  │       │   │
│  │  │ 이사일:    [2026-03-28]                  │       │   │
│  │  │ 출발지:    [서울 강남구...]               │       │   │
│  │  │ ...                                     │       │   │
│  │  └────────────────────────────────────────┘       │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

### 1.3 모드 비교

| | **모드 A: 가이드 대화** | **모드 B: 자유 입력** | **모드 C: 폼 직접** |
|--|----------------------|---------------------|-------------------|
| **UX** | 챗봇이 질문 → 버튼/카드로 답변 | 자유 텍스트 입력 → AI 파싱 | 전통적인 폼 필드 |
| **AI 호출** | ❌ 불필요 | ✅ Gemini API | ❌ 불필요 |
| **비용** | $0 | 건당 ~0.001원 | $0 |
| **장점** | 정확한 입력, 비용 절감, 빠른 응답 | 한 번에 많은 정보 입력 가능 | 익숙한 UI, 수정 용이 |
| **단점** | 질문이 많으면 지루할 수 있음 | AI 정확도 의존, 비용 발생 | 입력 항목 많아 보임 |
| **적합한 사용자** | 이사 경험 부족, 차분히 진행 | 이사 경험 있음, 빠르게 진행 | 기술 친화적 사용자 |
| **기본 모드** | ✅ 기본값 | 선택적 전환 | 탭으로 전환 |

---

## 2. 모드 A: 가이드 대화 (Rule-based Chatbot)

### 2.1 설계 원칙

- **AI API 호출 없음** — 모든 질문과 선택지는 프론트엔드 코드에서 관리
- **한 번에 하나의 질문** — 사용자 부담 최소화
- **선택형 UI 우선** — 버튼, 카드, 캘린더, 바텀시트 등 터치 친화적
- **"수정" 버튼** — 이전 답변을 탭하면 해당 질문으로 돌아가 수정 가능
- **자유 입력 전환** — 언제든 텍스트 입력 모드로 전환 가능

### 2.2 질문 시퀀스 (Step Flow)

> 참고 이미지: 짐싸만 앱의 가이드 대화 패턴

```
Step 1: 이사 예정일
├── UI: 캘린더 DatePicker (인라인)
├── 성수기 표시: 주말/공휴일 전날에 +20%, +30% 뱃지
├── Schema 매핑: move.schedule.date
└── 다음 →

Step 2: 현재 거주지 평수
├── UI: 숫자 입력 + "평" 단위
├── 또는 범위 선택: [10평 이하] [10~15평] [15~25평] ...
├── Schema 매핑: departure.squareFootage
└── 다음 →

Step 3: 이사 형태 선택
├── UI: 카드형 선택 (시각적 아이콘 + 설명)
│   ┌──────────┐ ┌──────────┐ ┌──────────┐
│   │ 포장이사   │ │ 반포장이사 │ │ 일반이사  │
│   │ 포장~정리  │ │ 큰짐 업체  │ │ 운반만   │
│   │ 업체 전담  │ │ 잔짐 고객  │ │ 고객 포장 │
│   │ [선택하기] │ │ [선택하기] │ │ [선택하기]│
│   └──────────┘ └──────────┘ └──────────┘
├── Schema 매핑: move.type
└── 다음 →

Step 4: 이사 시작 시간
├── UI: 버튼 리스트
│   [오전 7시] [오전 8시] [오전 9시]
│   [오후 1시] [오후 2시] [오후 3시]
│   [시간 협의]
├── Schema 매핑: move.timeSlot
└── 다음 →

Step 5: 출발지 주소
├── UI: 주소 검색 바 (카카오 주소 API)
├── Schema 매핑: departure.address, departure.detailAddress
└── 다음 →

Step 6: 출발지 운반 방식
├── UI: 버튼 선택 + 설명 텍스트
│   "출발지에서 짐을 어떻게 옮길까요?"
│   "계단으로 짐 옮기기 어려운 경우 사다리차가 필요합니다."
│   [엘리베이터] [계단 운반 작업] [사다리차 작업]
├── Schema 매핑: departure.hasElevator + services.ladderTruck
│   엘리베이터 → hasElevator: "yes"
│   계단 운반  → hasElevator: "no", ladderTruck: "not_required"
│   사다리차   → hasElevator: "no", ladderTruck: "required"
└── 다음 →

Step 7: 출발지 층수
├── UI: 지상/지하 토글 + 숫자 입력 + 확인 버튼
├── Schema 매핑: departure.floor, departure.floorStatus
└── 다음 →

Step 8: 도착지 주소
├── UI: 주소 검색 바 (카카오 주소 API)
├── Schema 매핑: arrival.address, arrival.detailAddress
└── 다음 →

Step 9: 도착지 운반 방식
├── UI: (Step 6과 동일)
├── Schema 매핑: arrival.hasElevator
└── 다음 →

Step 10: 도착지 층수
├── UI: (Step 7과 동일)
├── Schema 매핑: arrival.floor
└── 다음 →

Step 11: 트럭 대수 (용달/일반 이사 시)
├── 💡 팁 카드 (상단에 표시):
│   ┌─────────────────────────────────────────────┐
│   │ 🏷️ 트럭 선택 팁                              │
│   │ [🧊 냉장고] [🚪 옷장] → [🚛🚛 트럭 2대]      │
│   │ "아래 가구가 3개 이상이라면 2대가 적당해요"      │
│   │  양문형 냉장고/옷장/더블이상 침대/3인용 소파 중 3개│
│   └─────────────────────────────────────────────┘
├── UI: 버튼 리스트
│   "1톤 트럭 몇 대가 필요하세요?"
│   [🔗 1톤 트럭 가이드]  ← 도움말 링크
│   [1대] [2대] [잘 모르겠어요]
├── Schema 매핑: conditions.vehiclePreference
│   "잘 모르겠어요" → vehiclePreference: "unknown"
├── 조건: move.type이 "general" 또는 "carrier"일 때만 표시
│   (포장이사는 업체가 트럭 대수 판단)
└── 다음 →

Step 12: 작업인원 (용달/일반 이사 시)
├── 💡 팁 카드 (상단에 표시):
│   ┌─────────────────────────────────────────────┐
│   │ 🏷️ 작업인원 팁                               │
│   │ [👷‍♂️🧑 일러스트: 고객+기사 함께 작업]           │
│   │ "무거운 짐을 함께 옮길 수 있다면 약 13만원 저렴해요"│
│   │  냉장고, 옷장, 침대, 소파 등                    │
│   └─────────────────────────────────────────────┘
├── UI: 버튼 선택
│   "이사할 때 함께 작업하실 수 있나요?"
│   "함께 일하실 수 없다면 작업자 한 명을 추가하셔야 합니다."
│   [네, 같이 일할게요] [아니오, 한 명 추가할래요]
├── Schema 매핑: conditions.customerParticipation
│   "네" → customerParticipation: true
│   "아니오" → customerParticipation: false (추가 인원 비용 발생)
├── 조건: move.type이 "general" 또는 "carrier"일 때만 표시
│   (포장이사는 작업인원이 업체 소속)
└── 다음 →

Step 13: 자세한 짐 양과 요청사항 (필수)
├── UI: 텍스트 입력 (Textarea) + 예시 텍스트
│   "자세한 짐 양과 요청 사항을 알려주세요"
│   "추가금이 발생하지 않도록 큰 짐은 꼭 적어주세요."
│   
│   예시 가이드:
│   "ex) 퀸 침대, 냉장고, 5호 박스 20개,
│        17시 이후에 연락주세요."
│   
│   미리 채워진 텍스트 (이전 Step에서 수집된 정보 기반):
│   "킹 침대, 양문형 냉장고, 박스 10개,
│    19시 이후 통화가능"
│   [확인]
├── Schema 매핑: conditions.extraRequests + cargo 보완
├── ⚠️ 이 Step은 AI 파싱 대상이 될 수 있음:
│   사용자가 "킹 침대, 양문형 냉장고" 입력 시
│   → 선택적 AI 파싱으로 cargo 필드 보강 가능
│   → 하지만 MVP에서는 단순 텍스트 저장만으로 충분
└── 다음 →

Step 14: 부가 서비스 (선택)
├── UI: 토글 리스트
│   [○ 에어컨 이전설치 (  대)] [○ 입주청소] [○ 정리정돈]
│   [○ 보관 서비스] [○ 폐기물 처리]
├── Schema 매핑: services.*
├── 조건: move.type이 "full_pack" 또는 "half_pack"일 때 표시
│   (용달이사는 부가 서비스 해당 없음)
└── 다음 →

Step 15: 본인 인증 (필수 — 마지막)
├── UI: 인라인 본인 인증 위젯
│   "처음 한번 본인 인증이 필요해요"
│   [🔗 법인 명의 휴대폰인가요?]  ← 도움말 링크
│   
│   ┌──────────────────────────────────┐
│   │ 휴대폰 번호                        │
│   │ [010-1234-5678] [통신사 ▾]        │
│   │                                   │
│   │ 이름                               │
│   │ [홍길동]                           │
│   │                                   │
│   │ [인증번호 받기]                     │
│   │                                   │
│   │ 인증번호                           │
│   │ [123456]  [확인]                   │
│   └──────────────────────────────────┘
├── Schema 매핑: contact.name, contact.phone, contact.carrier
├── 검증: SMS 인증 완료 필수
└── 제출 →
```

### 2.3 질문 스킵 & 조건부 로직

| 조건 | 동작 |
|------|------|
| 이사 형태 = 용달/일반이사 | Step 11(트럭 대수) + Step 12(작업인원) **표시** |
| 이사 형태 = 포장/반포장이사 | Step 11(트럭 대수) + Step 12(작업인원) **스킵** (업체 판단) |
| 이사 형태 = 포장이사 | Step 14(부가 서비스)에서 "정리정돈" 자동 선택 |
| 이사 형태 = 용달이사 | Step 14(부가 서비스) **스킵** |
| 출발지 운반 = 엘리베이터 | 사다리차 관련 추가 질문 스킵 |
| 평수 ≤ 10평 (원룸) | Step 13(짐 양) 예시를 원룸 기준으로 축소 |

### 2.4 팁 카드 (Tip Card) 패턴

> 짐싸만 앱에서 발견한 중요한 UX 패턴.
> 사용자가 선택하기 어려운 질문 전에 **일러스트 + 가이드 텍스트**를 보여주어 판단을 도움.

```typescript
interface TipCard {
  id: string;
  badge: string;             // 뱃지 텍스트 (예: "트럭 선택 팁", "작업인원 팁")
  badgeColor: string;        // 뱃지 색상 (teal, blue, orange...)
  illustration?: string;     // 일러스트 이미지 URL (선택)
  title: string;             // 팁 제목 (굵은 글씨)
  description: string;       // 상세 설명
}

// 팁 카드 적용 대상
const TIP_CARDS: Record<string, TipCard> = {
  truck_count: {
    badge: '트럭 선택 팁',
    badgeColor: 'teal',
    illustration: '/tips/truck-guide.svg',
    title: '아래 가구가 3개 이상이라면 2대가 적당해요',
    description: '양문형 냉장고/옷장/더블이상 침대/3인용 소파 중 3개',
  },
  worker_participation: {
    badge: '작업인원 팁',
    badgeColor: 'teal',
    illustration: '/tips/worker-guide.svg',
    title: '무거운 짐을 함께 옮길 수 있다면 약 13만원 저렴해요',
    description: '냉장고, 옷장, 침대, 소파 등',
  },
  ladder_truck: {
    badge: '사다리차 안내',
    badgeColor: 'orange',
    illustration: '/tips/ladder-guide.svg',
    title: '3층 이상이고 엘리베이터가 없으면 사다리차를 추천해요',
    description: '사다리차 비용은 층수와 짐 양에 따라 5~15만원 정도입니다',
  },
  peak_season: {
    badge: '성수기 안내',
    badgeColor: 'red',
    title: '이 날짜는 이사 성수기예요',
    description: '금요일·주말·공휴일 전날은 평일 대비 20~30% 비쌀 수 있어요',
  },
};
```

### 2.4 구현 방식 (프론트엔드 코드)

```typescript
// lib/guided-flow/steps.ts

interface GuidedStep {
  id: string;
  question: string;                    // 질문 텍스트
  description?: string;                // 부가 설명
  inputType: 'calendar' | 'select' | 'card' | 'button_list' |
             'address' | 'number' | 'toggle_list' | 'checkbox_grid' |
             'text' | 'phone_verify';
  options?: StepOption[];              // 선택지 (해당 시)
  schemaPath: string;                  // Schema v2.0 매핑 경로
  required: boolean;
  tipCard?: TipCard;                   // 질문 전 표시할 팁 카드
  helpLink?: { label: string; url: string };  // 도움말 링크
  placeholder?: string;               // 텍스트 입력 시 예시 텍스트
  prefillFromSchema?: (schema: MovingSchema) => string;  // 이전 입력 기반 미리채움
  skipCondition?: (schema: MovingSchema) => boolean;  // 스킵 조건
  transform?: (value: any) => any;     // 값 변환 로직
}

const GUIDED_STEPS: GuidedStep[] = [
  {
    id: 'desired_date',
    question: '이사 예정일은 언제인가요?',
    description: '월초, 월말, 손없는 날, 공휴일 전날은\n인기 있는 날이니 서둘러 일정 확정해 보세요!',
    inputType: 'calendar',
    schemaPath: 'move.schedule',
    required: true,
  },
  {
    id: 'square_footage',
    question: '현재 거주지 평수를 입력해주세요',
    inputType: 'select',
    options: [
      { label: '10평 이하', value: 'under_10' },
      { label: '10~15평', value: '10_15' },
      { label: '15~25평', value: '15_25' },
      { label: '25~35평', value: '25_35' },
      { label: '35~45평', value: '35_45' },
      { label: '45평 이상', value: 'over_45' },
    ],
    schemaPath: 'departure.squareFootage',
    required: true,
  },
  {
    id: 'move_type',
    question: '원하시는 이사 종류를 선택해주세요',
    description: '포장 타입별로 6만원 정도의 차이가 있습니다.',
    inputType: 'card',
    options: [
      {
        label: '포장 이사',
        value: 'full_pack',
        description: '포장, 운반, 배치, 정리 모든 것을 업체에서 해드려요.',
        tags: ['포장', '운반', '배치', '정리'],
      },
      {
        label: '반포장 이사',
        value: 'half_pack',
        description: '주방 짐을 제외하고 포장, 운반, 큰 가구만 배치해 드려요.',
        tags: ['포장', '운반', '배치'],
      },
      {
        label: '직접 포장 (일반 이사)',
        value: 'general',
        description: '고객님이 분해/포장하신 가구, 짐을 파트너가 운반해 드려요.',
        tags: ['운반', '배치'],
      },
    ],
    schemaPath: 'move.type',
    required: true,
  },
  {
    id: 'time_slot',
    question: '이사 시작 시간은 언제가 좋으세요?',
    inputType: 'button_list',
    options: [
      { label: '오전 7시', value: 'early_morning_7' },
      { label: '오전 8시', value: 'early_morning_8' },
      { label: '오전 9시', value: 'morning_9' },
      { label: '오후 1시', value: 'early_afternoon_13' },
      { label: '오후 2시', value: 'early_afternoon_14' },
      { label: '오후 3시', value: 'late_afternoon_15' },
    ],
    schemaPath: 'move.timeSlot',
    required: true,
  },
  {
    id: 'departure_address',
    question: '현재 거주지를 알려주세요',
    inputType: 'address',
    schemaPath: 'departure.address',
    required: true,
  },
  {
    id: 'departure_transport',
    question: '출발지에서 짐을 어떻게 옮길까요?',
    description: '계단으로 짐 옮기기 어려운 경우 사다리차가 필요합니다.',
    inputType: 'button_list',
    options: [
      { label: '엘리베이터', value: 'elevator' },
      { label: '계단 운반 작업', value: 'stairs' },
      { label: '사다리차 작업', value: 'ladder' },
    ],
    schemaPath: 'departure.hasElevator',  // + services.ladderTruck 복합 매핑
    required: true,
    transform: (value: string) => {
      // elevator → { hasElevator: 'yes' }
      // stairs   → { hasElevator: 'no', ladderTruck: 'not_required' }
      // ladder   → { hasElevator: 'no', ladderTruck: 'required' }
    },
  },
  {
    id: 'departure_floor',
    question: '현재 거주지 층수를 입력해주세요',
    inputType: 'number',  // + 지상/지하 토글
    schemaPath: 'departure.floor',
    required: true,
  },
  {
    id: 'arrival_address',
    question: '도착지 주소를 알려주세요',
    inputType: 'address',
    schemaPath: 'arrival.address',
    required: true,
  },
  {
    id: 'arrival_transport',
    question: '도착지에서 짐을 어떻게 옮길까요?',
    inputType: 'button_list',
    options: [
      { label: '엘리베이터', value: 'elevator' },
      { label: '계단 운반 작업', value: 'stairs' },
      { label: '사다리차 작업', value: 'ladder' },
    ],
    schemaPath: 'arrival.hasElevator',
    required: true,
  },
  {
    id: 'arrival_floor',
    question: '도착지 층수를 입력해주세요',
    inputType: 'number',
    schemaPath: 'arrival.floor',
    required: true,
  },
  {
    id: 'truck_count',
    question: '1톤 트럭 몇 대가 필요하세요?',
    inputType: 'button_list',
    tipCard: TIP_CARDS.truck_count,
    helpLink: { label: '1톤 트럭 가이드', url: '/guide/truck' },
    options: [
      { label: '1대', value: '1' },
      { label: '2대', value: '2' },
      { label: '잘 모르겠어요', value: 'unknown' },
    ],
    schemaPath: 'conditions.vehiclePreference',
    required: false,
    skipCondition: (schema) =>
      schema.move.type === 'full_pack' || schema.move.type === 'half_pack',
  },
  {
    id: 'worker_participation',
    question: '이사할 때 함께 작업하실 수 있나요?',
    description: '함께 일하실 수 없다면 작업자 한 명을 추가하셔야 합니다.',
    inputType: 'button_list',
    tipCard: TIP_CARDS.worker_participation,
    options: [
      { label: '네, 같이 일할게요', value: 'yes' },
      { label: '아니오, 한 명 추가할래요', value: 'no' },
    ],
    schemaPath: 'conditions.customerParticipation',
    required: false,
    skipCondition: (schema) =>
      schema.move.type === 'full_pack' || schema.move.type === 'half_pack',
    transform: (value: string) => value === 'yes',
  },
  {
    id: 'detailed_cargo',
    question: '자세한 짐 양과 요청 사항을 알려주세요',
    description: '추가금이 발생하지 않도록\n큰 짐은 꼭 적어주세요.',
    inputType: 'text',
    placeholder: 'ex) 퀸 침대, 냉장고, 5호 박스 20개,\n17시 이후에 연락주세요.',
    prefillFromSchema: (schema) => {
      // 이전 Step에서 수집된 짐 정보를 미리 채워줌
      const items = [];
      if (schema.cargo?.refrigerator?.has) items.push('냉장고');
      if (schema.cargo?.washer?.has) items.push('세탁기');
      if (schema.cargo?.bed?.has) items.push(`${schema.cargo.bed.note || ''} 침대`);
      return items.join(', ');
    },
    schemaPath: 'conditions.extraRequests',
    required: true,
  },
  {
    id: 'services',
    question: '추가로 필요한 서비스가 있나요?',
    inputType: 'toggle_list',
    options: [
      { label: '에어컨 이전설치', value: 'airconInstall' },
      { label: '입주 청소', value: 'cleaning' },
      { label: '정리 정돈', value: 'organizing' },
      { label: '보관 서비스', value: 'storage' },
      { label: '폐기물 처리', value: 'disposal' },
    ],
    schemaPath: 'services',
    required: false,
    skipCondition: (schema) =>
      schema.move.type === 'carrier',  // 용달이사는 부가 서비스 스킵
  },
  {
    id: 'phone_verify',
    question: '처음 한번 본인 인증이 필요해요',
    helpLink: { label: '법인 명의 휴대폰인가요?', url: '/guide/corporate-phone' },
    inputType: 'phone_verify',
    schemaPath: 'contact',
    required: true,
  },
];
```

### 2.5 가이드 대화 UI 컴포넌트

```typescript
// components/chat/GuidedStep.tsx — 각 Step의 입력 컴포넌트 렌더링

interface GuidedStepProps {
  step: GuidedStep;
  onAnswer: (value: any) => void;
}

function GuidedStepRenderer({ step, onAnswer }: GuidedStepProps) {
  return (
    <div className="flex flex-col gap-3">
      {/* 팁 카드가 있으면 먼저 렌더링 */}
      {step.tipCard && <TipCardWidget tip={step.tipCard} />}

      {/* 질문 버블 */}
      <SystemBubble
        question={step.question}
        description={step.description}
        helpLink={step.helpLink}
      />

      {/* 입력 컴포넌트 */}
      {renderInput(step, onAnswer)}
    </div>
  );
}

function renderInput(step: GuidedStep, onAnswer: (value: any) => void) {
  switch (step.inputType) {
    case 'calendar':
      return <InlineDatePicker onSelect={onAnswer} />;

    case 'card':
      return (
        <div className="flex gap-2 overflow-x-auto pb-2">
          {step.options.map((opt) => (
            <MoveTypeCard key={opt.value} option={opt} onSelect={onAnswer} />
          ))}
        </div>
      );

    case 'button_list':
      return (
        <div className="flex flex-col gap-2">
          {step.options.map((opt) => (
            <OptionButton key={opt.value} label={opt.label}
              onClick={() => onAnswer(opt.value)} />
          ))}
        </div>
      );

    case 'address':
      return <KakaoAddressSearch onSelect={onAnswer} />;

    case 'number':
      return <FloorInput onConfirm={onAnswer} />;

    case 'checkbox_grid':
      return <CargoCheckboxGrid onChange={onAnswer} />;

    case 'toggle_list':
      return <ServiceToggleList options={step.options} onChange={onAnswer} />;

    case 'text':
      return <TextAreaInput
        placeholder={step.placeholder}
        defaultValue={step.prefillFromSchema?.(currentSchema)}
        onSubmit={onAnswer}
      />;

    case 'phone_verify':
      return <PhoneVerification
        helpLink={step.helpLink}
        onVerified={onAnswer}
      />;

    default:
      return <TextInput onSubmit={onAnswer} />;
  }
}
```

---

## 3. 모드 B: 자유 입력 (AI 파싱)

### 3.1 전환 시점

자유 입력 모드는 다음과 같은 경우에만 AI API를 호출합니다:

| 트리거 | 설명 | 예시 |
|--------|------|------|
| **사용자가 텍스트 입력** | 가이드 진행 중 텍스트 직접 타이핑 | "강남 원룸에서 마포 아파트로 3월 말에" |
| **"한번에 입력" 버튼** | 가이드 대화 상단에 전환 버튼 | "이사 정보를 한번에 입력할게요" 클릭 |
| **복합 정보 입력** | 여러 필드가 한 문장에 섞여 있을 때 | "냉장고 세탁기 침대 2개 있고 5층인데 엘베 없어요" |

### 3.2 AI 호출 판단 로직

```typescript
// lib/utils/inputDetector.ts

function shouldCallAI(userInput: string, currentStep: GuidedStep): boolean {
  // 1. 현재 Step의 options 중 하나와 정확히 매칭되면 → AI 불필요
  if (currentStep.options?.some(opt =>
    opt.label === userInput || opt.value === userInput
  )) {
    return false;
  }

  // 2. 단순 숫자만 입력 (층수, 평수) → AI 불필요
  if (currentStep.inputType === 'number' && /^\d+$/.test(userInput.trim())) {
    return false;
  }

  // 3. 복합 정보 감지 (여러 키워드 포함) → AI 호출
  const keywords = [
    '원룸', '투룸', '아파트', '오피스텔',
    '포장', '반포장', '용달',
    '층', '엘베', '엘리베이터', '계단', '사다리',
    '냉장고', '세탁기', 'TV', '에어컨', '침대', '소파',
    '강남', '마포', '수원', '서울',
  ];
  const matchCount = keywords.filter(kw => userInput.includes(kw)).length;

  // 2개 이상 키워드 매칭 → 복합 입력 → AI 호출
  if (matchCount >= 2) return true;

  // 4. 문장 길이가 긴 경우 (20자 이상) → AI 호출
  if (userInput.length >= 20) return true;

  // 5. 그 외 → 현재 Step의 context에서 단순 처리
  return false;
}
```

### 3.3 AI 호출 시 처리 흐름

```
[사용자 자유 텍스트 입력]
    ↓
[shouldCallAI() = true]
    ↓
[Gemini 2.5 Flash 호출]
    ├── 입력: 사용자 텍스트 + 현재 Schema 상태
    ├── 출력: 파싱된 필드들 + confidence
    ↓
[여러 필드 한번에 업데이트]
    ├── 가이드 대화에서 해당 Step들 자동 완료 처리
    ├── 채팅에 "이렇게 입력했어요" 요약 표시
    └── 남은 미입력 필드로 가이드 대화 이어서 진행
```

### 3.4 AI 호출 후 가이드 재개 예시

```
사용자: "원룸이고 3월 말에 강남에서 마포로 포장이사 해요"

AI 파싱 결과:
  ✅ move.category = one_room
  ✅ move.type = full_pack
  ✅ move.schedule = range (3/25~31)
  ✅ departure.address = 서울 강남구
  ✅ arrival.address = 서울 마포구

시스템 응답:
  "원룸 포장이사, 3월 말경, 강남→마포로 접수했어요! ✅
   몇 가지만 더 확인할게요."

  → 가이드 대화 재개: Step 4(시간) → Step 6(출발지 운반) → Step 7(층수) → ...
  (이미 답변된 Step 1,2,3,5,8 스킵)
```

---

## 4. 모드 C: 폼 직접 입력

### 4.1 용도

- 가이드 대화 진행 중 **"폼으로 보기" 탭**으로 전환
- 이미 입력된 정보를 한눈에 확인하고 수정
- 가이드 대화에서 답변한 내용이 실시간으로 폼에 반영

### 4.2 폼 ↔ 가이드 대화 동기화

```
[가이드 대화에서 "포장이사" 선택]
    → 폼의 "이사 형태" 필드 자동 반영
    → 가이드 대화의 해당 Step "✅ 완료" 표시

[폼에서 "이사 형태"를 "반포장이사"로 변경]
    → 가이드 대화의 해당 답변 버블 업데이트
    → "포장이사" → "반포장이사"로 수정됨 표시
```

---

## 5. AI 비용 최적화 효과

### 5.1 시나리오별 AI 호출 횟수

| 시나리오 | 기존 설계 | 개선 후 | 절감 |
|----------|----------|---------|------|
| **가이드 대화만 사용** (대부분 사용자) | 5~10회 호출 | **0회** | 100% |
| **자유 입력 1회 + 가이드 마무리** | 5~10회 | **1회** | 80~90% |
| **완전 자유 대화** | 5~10회 | **3~5회** | 30~50% |

### 5.2 예상 AI API 사용량 (일 50건 기준)

| | 기존 설계 | 개선 후 |
|--|----------|---------|
| 사용 비율 (추정) | 100% AI 호출 | 30%만 AI 호출 |
| 일 API 호출 수 | 250~500회 | **15~75회** |
| 월 토큰 사용량 | ~15M 토큰 | **~2M 토큰** |
| 월 비용 (Gemini Flash) | ~$0.50 | **~$0.07** |
| 무료 티어 내 유지 | ⚠️ 한도 근접 | ✅ 충분 |

> **핵심 효과:** 대부분의 사용자가 가이드 대화로 완료하므로, AI API 호출을 70~100% 절감. 무료 티어로 훨씬 오래 버틸 수 있음.

---

## 6. 채팅 UI 요소 타입 정의

가이드 대화에서 사용하는 UI 요소 (채팅 버블 안에 렌더링):

### 6.1 시스템 메시지 (질문)

```typescript
interface SystemMessage {
  type: 'system';
  content: string;          // 질문 텍스트
  description?: string;     // 부가 설명 (작은 글씨)
  inputComponent: string;   // 렌더링할 입력 컴포넌트 타입
  options?: Option[];       // 선택지
}
```

### 6.2 사용자 응답 (답변 버블)

```typescript
interface UserResponse {
  type: 'user';
  content: string;          // 선택한 값의 표시 텍스트
  value: any;               // 실제 값
  stepId: string;           // 어떤 Step의 답변인지
  editable: boolean;        // 수정 가능 여부 (기본 true)
}
```

### 6.3 채팅 버블 안의 위젯 종류

| 위젯 | 사용처 | 채팅 내 렌더링 |
|------|--------|--------------|
| **TipCard** ⭐ | 트럭 대수, 작업인원, 사다리차 | 뱃지 + 일러스트 + 가이드 텍스트 |
| **InlineDatePicker** | 이사일 선택 | 캘린더가 메시지 버블 안에 표시 |
| **CardSelector** | 이사 형태 선택 | 가로 스크롤 카드 |
| **ButtonList** | 시간/운반방식/트럭/작업인원 | 세로 버튼 리스트 |
| **AddressSearch** | 주소 입력 | 검색 바 + 결과 리스트 |
| **FloorInput** | 층수 입력 | 지상/지하 토글 + 숫자 + 확인 버튼 |
| **TextAreaInput** | 짐 양/요청사항 | Textarea + 예시 가이드 + 미리채움 |
| **ToggleList** | 부가 서비스 | 토글 스위치 리스트 |
| **PhoneVerify** | 본인 인증 | 전화번호 + 통신사 + 인증번호 |
| **HelpLink** | 트럭 가이드, 사다리차 안내 등 | 파란색 링크 텍스트 |

> ⭐ **TipCard는 새로 추가된 핵심 UX 패턴.** 사용자가 판단하기 어려운 질문(트럭 대수, 작업인원) 전에 시각적 가이드를 제공하여 이탈률을 낮춤.

---

## 7. 채팅 입력창 설계

### 7.1 입력창 모드

```
┌────────────────────────────────────────────────────┐
│                                                    │
│  가이드 대화 진행 중:                                │
│  [입력창 비활성] "위 버튼을 선택해주세요"              │
│                                                    │
│  하단 텍스트: "직접 입력하고 싶으시면 여기를 탭하세요"  │
│                                 ↓ 탭 시             │
│  [텍스트 입력 활성] "이사 정보를 자유롭게 입력하세요"   │
│                                                    │
└────────────────────────────────────────────────────┘
```

### 7.2 입력창 상태 전환

```typescript
type InputMode = 'guided' | 'free_text';

// 기본: guided → 버튼/카드로만 응답
// 사용자가 입력창 탭 → free_text → 키보드 올라옴
// 자유 텍스트 제출 → AI 파싱 → 결과 반영 → guided로 복귀
```

---

## 8. 기술 스택 업데이트 사항

### 8.1 변경된 아키텍처

```
기존:
  채팅 입력 → 항상 Gemini API → Schema 업데이트

변경:
  채팅 입력 → [가이드 대화?]
              ├── YES → 프론트엔드 로직만 → Schema 업데이트 (AI 없음)
              └── NO (자유 텍스트) → shouldCallAI() 판단
                  ├── YES → Gemini API → Schema 업데이트
                  └── NO (단순 입력) → 직접 매핑 → Schema 업데이트
```

### 8.2 프론트엔드 추가 모듈

```
src/
├── lib/
│   ├── guided-flow/
│   │   ├── steps.ts              # Step 정의 (질문 시퀀스)
│   │   ├── engine.ts             # Step 진행 엔진 (다음 Step 결정)
│   │   ├── conditions.ts         # 조건부 스킵 로직
│   │   └── transforms.ts         # 답변 → Schema 매핑 변환
│   ├── utils/
│   │   └── inputDetector.ts      # AI 호출 필요 여부 판단
│   ...
│
├── components/
│   ├── chat/
│   │   ├── GuidedStep.tsx        # 가이드 Step 렌더러
│   │   ├── InlineDatePicker.tsx  # 캘린더 위젯
│   │   ├── CardSelector.tsx      # 카드형 선택
│   │   ├── ButtonList.tsx        # 버튼 리스트
│   │   ├── FloorInput.tsx        # 층수 입력 (지상/지하 토글)
│   │   ├── CargoCheckboxGrid.tsx # 짐 체크박스 그리드
│   │   └── ServiceToggleList.tsx # 부가 서비스 토글
│   ...
```

### 8.3 Gemini API 호출 정책 업데이트

| 정책 | 기존 | 변경 |
|------|------|------|
| 호출 시점 | 매 채팅 메시지마다 | 자유 텍스트 입력 시에만 |
| 예상 호출 비율 | 100% | ~30% |
| 무료 티어 여유 | ⚠️ 일 250~500건 | ✅ 일 15~75건 |
| 폴백 필요성 | 높음 | 낮음 (무료 한도 내 안정) |

---

## 9. 전체 사용자 플로우 (통합)

```
[견적 신청 페이지 진입]
    │
    ├── 상단 안내: "대화를 통해 간편하게 이사 견적을 신청하세요"
    │              "직접 입력을 원하면 [폼] 탭을 눌러주세요"
    │
    ▼
[채팅 탭 (기본)]
    │
    ├── 🤖 "이사 예정일은 언제인가요?"
    │   └── [📅 캘린더] ← 가이드 대화 (AI 없음)
    │
    ├── 👤 "3월 28일(토)" 선택
    │
    ├── 🤖 "현재 거주지 평수를 입력해주세요"
    │   └── [10평 이하] [10~15평] ... ← 가이드 대화 (AI 없음)
    │
    ├── 👤 "10~15평" 선택
    │
    ├── ... (가이드 대화 계속)
    │
    ├── 👤 도중에 자유 텍스트 입력:
    │   "냉장고 세탁기 있고 5층인데 엘베 없어요"
    │   └── shouldCallAI() = true → Gemini 호출
    │   └── 파싱 결과: cargo + floor + elevator 한번에 업데이트
    │   └── 이미 답변된 Step 스킵, 남은 Step으로 가이드 재개
    │
    ├── ... (가이드 대화 마무리)
    │
    ├── 🤖 "마지막으로 연락처를 알려주세요"
    │   └── [이름] [전화번호] [인증] ← SMS 인증
    │
    ▼
[정보 확인 페이지]
    │ 전체 입력 요약 + 약관 동의
    ▼
[견적 제출]
```

---

## 10. PRD/기술 스택 문서 반영 사항 요약

| 문서 | 변경 항목 |
|------|-----------|
| **PRD v1.1** | 유저 플로우에 "가이드 대화 → 자유 입력 전환" 흐름 추가 |
| **Input Schema v2.0** | meta.source에 "guided" 옵션 추가 |
| **기술 스택 v1.0** | Gemini 호출 정책 업데이트, guided-flow 모듈 추가, AI 비용 추정 수정 |
